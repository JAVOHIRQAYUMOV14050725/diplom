<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RFID PRO | Next Gen Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            dark: {
              900: '#020617',
              800: '#0f172a',
              700: '#1e293b',
            },
            neon: {
              purple: '#8b5cf6',
              blue: '#3b82f6',
              cyan: '#06b6d4',
              pink: '#ec4899'
            }
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            fadeIn: {
              'from': { opacity: '0', transform: 'translateY(10px)' },
              'to': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #020617;
      background-image: 
        radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%);
      background-attachment: fixed;
      color: #e2e8f0;
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .glass-panel:hover {
      border-color: rgba(255, 255, 255, 0.15);
    }

    .glass-input {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.05);
      color: white;
      transition: all 0.3s ease;
    }
    .glass-input:focus {
      background: rgba(30, 41, 59, 0.8);
      border-color: #8b5cf6;
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
      outline: none;
    }

    .text-glow {
      text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen selection:bg-neon-purple selection:text-white overflow-x-hidden">

  <!-- Background Ambient Glows -->
  <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
    <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-600/20 rounded-full blur-[120px] animate-pulse-slow"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-600/20 rounded-full blur-[120px] animate-pulse-slow" style="animation-delay: 2s;"></div>
  </div>

  <!-- NAVIGATION -->
  <nav class="sticky top-4 z-50 px-4 md:px-6 mb-8">
    <div class="glass-panel rounded-2xl px-6 py-4 flex justify-between items-center max-w-7xl mx-auto">
      <div class="flex items-center gap-4">
        <div class="relative group">
          <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg blur opacity-40 group-hover:opacity-100 transition duration-200"></div>
          <div class="relative bg-dark-900 p-2.5 rounded-lg border border-white/10">
            <i data-lucide="cpu" class="text-white w-6 h-6"></i>
          </div>
        </div>
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-white">RFID <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 text-glow">PRO</span></h1>
          <p class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold">Tizim holati: <span class="text-emerald-400">ONLINE</span></p>
        </div>
      </div>
      
      <div class="hidden md:flex items-center gap-4">
        <div class="group relative">
           <input id="testUid" type="text" placeholder="UID testlash..." 
                  class="glass-input pl-10 pr-4 py-2.5 rounded-xl text-sm w-64 font-mono placeholder-slate-500">
           <i data-lucide="scan" class="w-4 h-4 absolute left-3 top-3 text-slate-400 group-hover:text-blue-400 transition-colors"></i>
        </div>
        <button onclick="testScan()" class="relative overflow-hidden group bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(37,99,235,0.3)] hover:shadow-[0_0_30px_rgba(37,99,235,0.5)]">
          <span class="relative z-10 flex items-center gap-2 font-medium">
            <i data-lucide="zap" class="w-4 h-4 fill-current"></i> Test
          </span>
        </button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 md:px-6 pb-12 space-y-8">
    
    <!-- STATS OVERVIEW -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="glass-panel p-6 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i data-lucide="users" class="w-24 h-24 text-white"></i>
        </div>
        <div class="relative z-10">
          <p class="text-sm text-slate-400 font-medium mb-1">Umumiy Foydalanuvchilar</p>
          <h3 id="stat-users-count" class="text-4xl font-bold text-white font-mono tracking-tighter">0</h3>
        </div>
      </div>

      <div class="glass-panel p-6 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i data-lucide="activity" class="w-24 h-24 text-emerald-400"></i>
        </div>
        <div class="relative z-10">
          <p class="text-sm text-slate-400 font-medium mb-1">Bugungi Kirishlar</p>
          <h3 id="stat-entries-count" class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-300 to-emerald-500 font-mono tracking-tighter">0</h3>
          <div class="mt-4 w-full bg-slate-800/50 rounded-full h-1.5 overflow-hidden">
             <div class="bg-emerald-500 h-full w-[0%]" id="entries-bar" style="transition: width 1s ease;"></div>
          </div>
        </div>
      </div>

      <div class="glass-panel p-6 rounded-3xl relative overflow-hidden group hover:-translate-y-1 transition-transform duration-300">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
          <i data-lucide="shield-alert" class="w-24 h-24 text-rose-500"></i>
        </div>
        <div class="relative z-10">
          <p class="text-sm text-slate-400 font-medium mb-1">Rad Etilganlar</p>
          <h3 id="stat-denied-count" class="text-4xl font-bold text-rose-400 font-mono tracking-tighter">0</h3>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- LEFT SIDE -->
      <div class="lg:col-span-8 space-y-8">
        <div class="glass-panel p-8 rounded-3xl relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500"></div>
          
          <div class="flex items-center gap-3 mb-8">
            <div class="p-3 rounded-xl bg-gradient-to-br from-purple-600/20 to-blue-600/20 border border-white/10">
              <i data-lucide="user-plus" class="text-purple-400"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold text-white">Yangi Foydalanuvchi</h2>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
            <div class="md:col-span-3">
               <input id="uid" type="text" placeholder="UID" class="glass-input w-full h-12 rounded-xl px-4 font-mono text-sm">
            </div>
            <div class="md:col-span-4">
               <input id="name" type="text" placeholder="To'liq ism" class="glass-input w-full h-12 rounded-xl px-4 text-sm">
            </div>
            <div class="md:col-span-3">
               <select id="role" class="glass-input w-full h-12 rounded-xl px-4 text-sm cursor-pointer">
                 <option value="" class="bg-dark-900">Rolni tanlang</option>
                 <option value="student" class="bg-dark-900 text-white">üéì Talaba</option>
                 <option value="teacher" class="bg-dark-900 text-white">üë®‚Äçüè´ O'qituvchi</option>
                 <option value="staff" class="bg-dark-900 text-white">üíº Xodim</option>
                 <option value="admin" class="bg-dark-900 text-white">üõ°Ô∏è Admin</option>
               </select>
            </div>
            <div class="md:col-span-2">
              <button onclick="addUser()" class="w-full h-12 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium shadow-lg hover:brightness-110 active:scale-95 flex items-center justify-center">
                <i data-lucide="save" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- USERS TABLE -->
        <div class="glass-panel rounded-3xl overflow-hidden min-h-[400px]">
          <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
            <h2 class="text-lg font-bold flex items-center gap-2 text-white">
              <i data-lucide="database" class="text-blue-400"></i>
              <span>Baza Reyestri</span>
            </h2>
            <button onclick="loadUsers()" class="p-2 rounded-lg hover:bg-white/5 text-slate-400 hover:text-white transition group">
              <i data-lucide="refresh-cw" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500"></i>
            </button>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-slate-400 text-xs uppercase tracking-wider border-b border-white/5">
                  <th class="px-6 py-4 font-medium">UID</th>
                  <th class="px-6 py-4 font-medium">Ism</th>
                  <th class="px-6 py-4 font-medium">Rol</th>
                  <th class="px-6 py-4 font-medium text-right">Amallar</th>
                </tr>
              </thead>
              <tbody id="users-tbody" class="divide-y divide-white/5 text-sm"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE: LOGS -->
      <div class="lg:col-span-4">
        <div class="glass-panel rounded-3xl overflow-hidden sticky top-24 border-t-4 border-t-emerald-500 flex flex-col h-[calc(100vh-8rem)]">
          <div class="p-5 bg-gradient-to-b from-emerald-500/10 to-transparent border-b border-white/5 flex justify-between items-center">
            <h2 class="text-white font-bold flex items-center gap-2 text-lg">
              <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
              </span>
              Jonli Monitoring
            </h2>
            <button onclick="clearLogs()" class="text-[10px] uppercase tracking-wider text-slate-500 hover:text-white border border-slate-700 px-2 py-1 rounded">Tozalash</button>
          </div>
          <div id="logs-container" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- TOAST CONTAINER -->
  <div id="toast-container" class="fixed bottom-6 right-6 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<script>
  // --- Configuration ---
  const API = '/api';
  const RFID_API = `${API}/rfid`;

  // --- Counters ---
  let currentLogsCount = 0;
  let deniedCount = 0;

  // --- UI: Show Toast ---
  function showToast(message, type = "success") {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const bgColor = type === "success" ? "bg-emerald-500" : "bg-rose-500";
    
    toast.className = `${bgColor} text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-bounce pointer-events-auto min-w-[300px]`;
    toast.innerHTML = `
      <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
      <span class="font-medium">${message}</span>
    `;
    
    container.appendChild(toast);
    lucide.createIcons();
    
    setTimeout(() => {
      toast.classList.remove('animate-bounce');
      toast.classList.add('opacity-0', 'translate-x-full', 'transition-all', 'duration-500');
      setTimeout(() => toast.remove(), 500);
    }, 3000);
  }

  // --- SSE Setup ---
  function setupSSE() {
    const es = new EventSource(`${RFID_API}/stream`);

    es.addEventListener('log', e => {
      try {
        const { row } = JSON.parse(e.data);
        appendLog(row);
      } catch (err) { console.error('Log error', err); }
    });

    es.addEventListener('denied', e => {
      try {
        const { row } = JSON.parse(e.data);
        row.status = 'denied';
        appendLog(row);
        showToast(`OGOHLANTIRISH: Notanish karta! UID: ${row.uid}`, "error");
      } catch (err) { console.error('Denied error', err); }
    });

    es.onerror = () => {
      es.close();
      setTimeout(setupSSE, 3000);
    };
  }

  // --- Test Scan ---
  async function testScan() {
    const uidInput = document.getElementById('testUid');
    const uid = uidInput.value.trim();
    if (!uid) return showToast("UID kiriting", "error");

    try {
      const r = await fetch(RFID_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid })
      });

      if (!r.ok) {
        const payload = await safeJson(r);
        showToast(payload?.error || 'Rad etildi', "error");
      } else {
        showToast("Muvaffaqiyatli skanerlandi", "success");
        uidInput.value = '';
      }
    } catch (e) {
      showToast("API xatosi", "error");
    }
  }

  // Helper
  async function safeJson(resp) {
    try { return await resp.json(); } catch (e) { return null; }
  }

  // --- Users Logic ---
  async function loadUsers() {
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = `<tr><td colspan="4" class="p-12 text-center text-slate-500 animate-pulse">Yuklanmoqda...</td></tr>`;

    try {
      const r = await fetch(`${API}/users`);
      const payload = await safeJson(r);
      const users = Array.isArray(payload) ? payload : (payload?.data || []);

      animateValue("stat-users-count", parseInt(document.getElementById('stat-users-count').innerText) || 0, users.length, 500);

      tbody.innerHTML = '';
      if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-600 italic">Baza bo'sh</td></tr>`;
        return;
      }

      users.forEach((u, i) => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-white/5 transition-colors group";
        tr.style.animation = `fadeIn 0.4s ease-out forwards ${i * 0.05}s`;
        tr.style.opacity = '0';

        const roleColor = u.role === 'admin' ? 'rose' : (u.role === 'teacher' ? 'blue' : 'emerald');

        tr.innerHTML = `
          <td class="px-6 py-4 font-mono text-xs text-slate-400 group-hover:text-white">
            <span class="bg-white/5 px-2 py-1 rounded border border-white/10">${u.uid}</span>
          </td>
          <td class="px-6 py-4 font-medium text-slate-200">${u.name || 'Noma\'lum'}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-${roleColor}-500/30 text-${roleColor}-400 bg-${roleColor}-500/10">
              ${u.role || 'GUEST'}
            </span>
          </td>
          <td class="px-6 py-4 text-right">
            <button onclick="deleteUser(${u.id})" class="text-slate-500 hover:text-rose-500 p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-all">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      lucide.createIcons();
    } catch (err) {
      showToast("Xatolik: Yuklab bo'lmadi", "error");
    }
  }

  async function addUser() {
    const uidInp = document.getElementById('uid');
    const nameInp = document.getElementById('name');
    const roleInp = document.getElementById('role');

    const data = { uid: uidInp.value.trim(), name: nameInp.value.trim(), role: roleInp.value };
    if (!data.uid) return showToast("UID shart", "error");

    try {
      const res = await fetch(`${API}/users`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        showToast("Qo'shildi");
        uidInp.value = ''; nameInp.value = ''; roleInp.value = '';
        loadUsers();
      } else {
        const err = await safeJson(res);
        showToast(err?.error || "Xatolik", "error");
      }
    } catch (e) { showToast("Tarmoq xatosi", "error"); }
  }

  async function deleteUser(id) {
    if (!confirm("O'chirilsinmi?")) return;
    try {
      const res = await fetch(`${API}/users/${id}`, { method: 'DELETE' });
      if (res.ok) { showToast("O'chirildi"); loadUsers(); }
    } catch (e) { showToast("Xatolik", "error"); }
  }

  function appendLog(log) {
    const container = document.getElementById('logs-container');
    const time = new Date().toLocaleTimeString('uz-UZ', { hour12: false });

    const isDenied = log.status === 'denied';
    const isExit = log.action === 'exit';
const isEntry = log.action === 'entry';

    if (isDenied) {
      deniedCount++;
      animateValue("stat-denied-count", parseInt(document.getElementById('stat-denied-count').innerText) || 0, deniedCount, 300);
    } else {
if (!isDenied && log.action === 'entry') {
  currentLogsCount++;
  animateValue(
    "stat-entries-count",
    parseInt(document.getElementById('stat-entries-count').innerText) || 0,
    currentLogsCount,
    300
  );
}
      animateValue("stat-entries-count", parseInt(document.getElementById('stat-entries-count').innerText) || 0, currentLogsCount, 300);
      const bar = document.getElementById('entries-bar');
      bar.style.width = Math.min((currentLogsCount / 100) * 100, 100) + '%';
    }

    const logDiv = document.createElement('div');
  const statusClass = isDenied
  ? 'border-rose-500 bg-rose-500/5'
  : isExit
    ? 'border-blue-500 bg-blue-500/5'
    : 'border-emerald-500 bg-emerald-500/5';
    
    logDiv.className = `p-3 rounded-xl border-l-4 ${statusClass} animate-fadeIn`;
logDiv.innerHTML = `
  <div class="flex justify-between items-start">
    <div class="flex items-center gap-3">
      <i
        data-lucide="${
          isDenied
            ? 'shield-alert'
            : isExit
              ? 'log-out'
              : 'log-in'
        }"
        class="w-4 h-4 ${
          isDenied
            ? 'text-rose-400'
            : isExit
              ? 'text-blue-400'
              : 'text-emerald-400'
        }"
      ></i>

      <div>
        <h4 class="text-sm font-semibold text-slate-200">
          ${log.name || 'Notanish'}
          ${
            !isDenied
              ? `<span class="ml-2 text-[10px] font-bold ${
                  isExit ? 'text-blue-400' : 'text-emerald-400'
                }">
                  ${isExit ? 'CHIQDI' : 'KIRDI'}
                </span>`
              : ''
          }
        </h4>

        <p class="text-[10px] text-slate-500 font-mono">
          UID: ${log.uid}
        </p>
      </div>
    </div>

    <span class="text-[10px] text-slate-400">
      ${time}
    </span>
  </div>
`;

    container.prepend(logDiv);
    lucide.createIcons();
    if (container.children.length > 50) container.lastElementChild.remove();
  }

  function clearLogs() {
    document.getElementById('logs-container').innerHTML = '';
  }

  function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      obj.innerHTML = Math.floor(progress * (end - start) + start);
      if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
  }

  window.onload = () => {
    loadUsers();
    setupSSE();
    lucide.createIcons();
  };
</script>
</body>
</html>